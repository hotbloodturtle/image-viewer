<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <style>
      .animal__merged {
        display: flex;
        width: 100vw;
        align-items: center;
        margin-top: 100px;
      }
      .animal__merged--left,
      .animal__merged--right {
        width: 50%;
        height: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
      }
      .animal__merged--left {
        justify-content: flex-end;
      }
      .img-animal__merged--right {
        justify-content: flex-start;
        margin-left: 50px;
      }
      img {
        max-width: 60%;
        min-width: 500px;
      }
    </style>
  </head>
  <body>
    <div class="animal">
      <ul class="animal__list"></ul>
      <ul class="animal__detail"></ul>
    </div>
    <script>
      // constants
      const _animalListNode = document.querySelector(".animal__list");
      const _animalDetailNode = document.querySelector(".animal__detail");

      // variable
      let _timerId;

      // functions
      const renderAnimal = (names) => {
        _animalListNode.textContent = "";

        names.forEach((name) => {
          const li = document.createElement("li");
          li.textContent = name;
          li.classList.add("animal__item");
          _animalListNode.appendChild(li);
        });
      };

      const getAnimals = () => {
        document.querySelector(".animal__detail").style.visibility = "hidden";
        document.querySelector(".animal__list").style.visibility = "visible";

        fetch("/animals")
          .then((response) => response.text())
          .then((text) => {
            renderAnimal(JSON.parse(text));
          });
      };

      const getResults = (dir) => {
        document.querySelector(".animal__list").style.visibility = "hidden";
        document.querySelector(".animal__detail").style.visibility = "visible";

        fetch(`/results?dir=${dir}&test=test`)
          .then((response) => response.text())
          .then((text) => JSON.parse(text))
          .then(({ animals, characters }) => {
            // const randomAnimals = animals.sort(() => 0.5 - Math.random());
            const randomAnimals = animals;
            const randomCharacters = characters.sort(
              () => Math.random() - Math.random()
            );

            for (let i = 0; i < animals.length; i++) {
              const merged = document.createElement("div");
              merged.classList.add("animal__merged");

              const left = document.createElement("div");
              left.classList.add("animal__merged--left");
              const leftImg = document.createElement("img");
              leftImg.src =
                "/" + randomAnimals[getRandomInt(0, animals.length)];
              leftImg.classList.add("animal-image");
              left.appendChild(leftImg);
              merged.appendChild(left);

              const right = document.createElement("div");
              right.classList.add("animal__merged--right");
              const rightImg = document.createElement("img");
              rightImg.src =
                "/" + randomCharacters[getRandomInt(0, characters.length)];
              right.appendChild(rightImg);
              merged.appendChild(right);

              _animalDetailNode.appendChild(merged);
            }
          });
      };

      const getRandomInt = (min, max) => {
        min = Math.ceil(min);
        max = Math.floor(max);
        return Math.floor(Math.random() * (max - min)) + min;
      };

      // init
      document.addEventListener("DOMContentLoaded", () => {
        if (window.location.pathname.indexOf("animal") > -1) {
          ((list) => {
            getResults(list[list.length - 1]);
          })(window.location.pathname.split("/"));
        } else if (window.location.pathname === "/") {
          getAnimals();
        }

        _animalListNode.addEventListener("click", (e) => {
          if (e.target.classList.contains("animal__item")) {
            const dir = e.target.textContent;
            window.history.pushState({}, "", `/animal/${dir}`);
            getResults(dir);
          }
        });

        _animalDetailNode.addEventListener("mousedown", (e) => {
          if (e.target.classList.contains("animal-image"))
            _timerId = setTimeout(() => {
              const animalName = prompt("animal name");
              const animalPath = e.target.src;
              fetch("/create-folder", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({ animalName, animalPath }),
              });
            }, 1000);
        });
        _animalDetailNode.addEventListener("mouseup", (e) => {
          clearTimeout(_timerId);
        });

        window.onpopstate = (e) => {
          if (window.location.pathname.indexOf("animal") > -1) {
            ((list) => {
              getResults(list[list.length - 1]);
            })(window.location.pathname.split("/"));
          } else if (window.location.pathname === "/") {
            getAnimals();
          }
        };
      });
    </script>
  </body>
</html>
